<!DOCTYPE html>
<html>
  <head>
    <title>Meld Solver</title>
    <script src="meldgame.js"></script>
    <script src="meldview.js"></script>
    <script src="meldcontroller.js"></script>
    <script src="solver.js"></script>
    <script>
    var controller = new MeldController();
    var worker, solver;
    var autoMove;
    var highestCounts = {};
    try {
      worker = new Worker("worker.js");
      worker.addEventListener("message", workerMessageHandler, false);
    } catch (e) {
      console.log('Could not construct worker. Using main thread.');
      solver = new Solver(3, 2);
    }

    function workerMessageHandler(event) {
      var move = event.data;
      makeAutoMove(move);
    }

    function handleToggleAutoMove(event) {
      autoMove = event.target.checked;
      if (autoMove) {
        requestBestMove();
      }
    }
    
    function logAndReset() {
      console.log(controller.nextValueList);
      console.log(controller.nextValueList.length);
      console.log(controller.game);
      var hiVal = controller.game.highestValue();
      if (!highestCounts[hiVal]) {
        highestCounts[hiVal] = 0;
      }
      highestCounts[hiVal]++;
      newGame();
    }

    function handleNewGame(event) {
      newGame();
    }

    function init() {
      var checkbox = document.getElementById('toggleAutoMove');
      autoMove = checkbox.checked;
      checkbox.addEventListener('click', handleToggleAutoMove);
      document.getElementById('newGame').addEventListener('click', handleNewGame);
      newGame();
    }

    function newGame() {
      controller.startNewGame();
      if (autoMove) {
        requestBestMove();
      }
    }

    function requestBestMove() {
      if (worker) {
        worker.postMessage(controller.game.copy());
      } else {
        var move = solver.findBestMove(controller.game.copy());
        makeAutoMove(move);
      }
    }
    function makeAutoMove(move) {
      if (move == 'NONE') {
        logAndReset();
        return;
      }
      var wasSuccessful = controller.move(MeldGame.Move[move]);
      if (wasSuccessful && autoMove) {
        window.setTimeout(requestBestMove, 10);
      }
    }
    </script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    </head>
    <body onload="init();">
      <h3>Please check out <a href="http://asherv.com/threes/">Threes</a>!</h3>
      <label><input type="checkbox" id="toggleAutoMove">Auto-move</label>
      <br>
      <input type="button" id="newGame" value="New Game">
      <br>
      <div id="nextPieceContainer"><div>Next</div></div>
      <div id="gameBoard" tabindex=0></div>
    </body>
</html>
