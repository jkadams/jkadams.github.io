<!DOCTYPE html>
<html>
  <head>
    <title>Meld Solver</title>
    <script src="meldgame.js"></script>
    <script src="meldview.js"></script>
    <script src="meldcontroller.js"></script>
    <script src="solver.js"></script>
    <script>
    var controller = new MeldController();
    var worker, solver;
    var autoMove;
    try {
      worker = new Worker("worker.js");
      worker.addEventListener("message", workerMessageHandler, false);
    } catch (e) {
      console.log('Could not construct worker. Using main thread.');
      solver = new Solver(3, 1);
    }

    function workerMessageHandler(event) {
      var move = event.data;
      if (move == 'NONE') {
        console.log(controller.nextValueString);
        return;
      }
      var wasSuccessful = makeMove(move);
      if (wasSuccessful && autoMove) {
        window.setTimeout(requestBestMove, 250);
      }
    }

    function handleToggleAutoMove(event) {
      autoMove = event.target.checked;
      if (autoMove) {
        requestBestMove();
      }
    }

    function handleNewGame(event) {
      newGame();
    }

    function init() {
      var checkbox = document.getElementById('toggleAutoMove');
      autoMove = checkbox.checked;
      checkbox.addEventListener('click', handleToggleAutoMove);
      document.getElementById('newGame').addEventListener('click', handleNewGame);
      newGame();
    }

    function newGame() {
      controller.startNewGame();
      if (autoMove) {
        requestBestMove();
      }
    }

    function requestBestMove() {
      if (worker) {
        worker.postMessage(controller.game.copy());
      } else {
        var move = solver.findBestMove(controller.game.copy());
        var wasSuccessful = makeMove(move);
        if (wasSuccessful && autoMove) {
          window.setTimeout(requestBestMove, 250);
        }
      }
    }
    function makeMove(move) {
      return controller.move(Move[move]);
    }
    </script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
  </head>
  <body onload="init();">
  	<label><input type="checkbox" id="toggleAutoMove">Auto-move</label>
    <br>
    <input type="button" id="newGame" value="New Game">
  	<br>
  </body>
</html>
